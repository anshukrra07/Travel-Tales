<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Category Results</title>
    <link rel="stylesheet" href="index-style.css">
    <link rel="stylesheet" href="dynamic-style.css">
    <link rel="stylesheet" href="descat-style.css">
</head>
<body>
    <header>
        <a href="index.html" class="logo">Tra<span>vel</span></a>
        <div class="h-right">
            <input type="text" id="search-bar" placeholder="Search places..." onkeyup="searchPlaces()" class="nav-btn">
            <div class="fa fa-bars navbar-link" id="menu-icon"></div>
        </div>
    </header>

    <div class="destination-header" id="destination-header">
        <h1 id="category-name">Category: Loading...</h1>
    </div>

    <!-- Filter and Sort Options -->
    <div class="filter-sort-container">
        <label for="sort-by">Sort By:</label>
        <select id="sort-by" onchange="sortPlaces()">
            <option value="rating">Rating (High to Low)</option>
            <option value="name">Name (A-Z)</option>
        </select>

        <label for="filter-by">Filter By:</label>
        <select id="filter-by" onchange="filterPlaces()">
            <option value="all">All</option>
            <option value="restaurant">Restaurants</option>
            <option value="hotel">Hotels</option>
            <option value="tourist_attraction">Tourist Attractions</option>
        </select>
    </div>

    <!-- Places Grid -->
    <div class="destination-container">
        <section class="destination-detail">
            <h2>Top Famous Places</h2>
            <div id="top-places" class="places-grid"></div>
        </section>
    </div>

    <div class="destination-container">
        <section class="destination-detail">
            <h2>All Available Places</h2>
            <div id="all-places" class="places-grid"></div>
        </section>
    </div>
    
    <script>
let places = [];

document.addEventListener("DOMContentLoaded", function () {
    const urlParams = new URLSearchParams(window.location.search);
    const query = urlParams.get("query");

    if (!query) {
        document.getElementById("search-query").textContent = "No Search Query Provided";
        return;
    }

    document.getElementById("search-query").textContent = `Search Results for: ${query}`;

    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
            position => fetchPlaces(query, position.coords.latitude, position.coords.longitude),
            () => fetchPlaces(query, null, null)
        );
    } else {
        fetchPlaces(query, null, null);
    }
});

// ‚úÖ Fetch Places Using Google Places API
function fetchPlaces(query, lat, lng) {
    const map = new google.maps.Map(document.getElementById("hidden-map")); // Required for PlacesService
    const service = new google.maps.places.PlacesService(map);

    let request = { query: query };

    if (lat && lng) {
        request.location = new google.maps.LatLng(lat, lng);
        request.radius = 15000; // 15km radius
    }

    service.textSearch(request, (results, status) => {
        if (status === google.maps.places.PlacesServiceStatus.OK) {
            places = results;
            displayPlaces(places);
        } else {
            document.getElementById("all-places").innerHTML = "<p>No places found.</p>";
        }
    });
}

// ‚úÖ Display Places Properly
function displayPlaces(places) {
    const container = document.getElementById("all-places");
    container.innerHTML = "";

    places.forEach(place => {
        const placeName = place.name || "Unknown Name";
        const placeAddress = place.formatted_address || "Address not available";
        const placeRating = place.rating ? `‚≠ê ${place.rating}/5` : "No rating available";
        const placeId = place.place_id;
        let placeImage = "images/default.jpg";

        if (place.photos && place.photos.length > 0) {
            placeImage = place.photos[0].getUrl({ maxWidth: 400 });
        }

        const placeCard = document.createElement("div");
        placeCard.classList.add("place-card");
        placeCard.innerHTML = `
            <a href="nearby-place.html?place_id=${placeId}">
                <img src="${placeImage}" alt="${placeName}" class="place-img">
                <div class="place-info">
                    <strong>${placeName}</strong>
                    <p>üìç ${placeAddress}</p>
                    <p>${placeRating}</p>
                </div>
            </a>
        `;

        container.appendChild(placeCard);
    });
}

// ‚úÖ Sort Places by Rating or Name
function sortPlaces() {
    const sortBy = document.getElementById("sort-by").value;
    if (sortBy === "rating") {
        places.sort((a, b) => (b.rating || 0) - (a.rating || 0));
    } else if (sortBy === "name") {
        places.sort((a, b) => a.name.localeCompare(b.name));
    }
    displayPlaces(places);
}

        function sortPlaces() {
            const sortBy = document.getElementById("sort-by").value;
            if (sortBy === "rating") {
                places.sort((a, b) => (b.rating || 0) - (a.rating || 0));
            } else if (sortBy === "name") {
                places.sort((a, b) => a.name.localeCompare(b.name));
            }
            displayPlaces(places);
        }

        function filterPlaces() {
            const filterBy = document.getElementById("filter-by").value;
            let filteredPlaces = places;
            if (filterBy !== "all") {
                filteredPlaces = places.filter(place => place.types.includes(filterBy));
            }
            displayPlaces(filteredPlaces);
        }
    </script>
    
</body>
</html>
